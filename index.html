<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FluxShift | USDC Cross-Chain Bridge</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#030306;--card:#0d0d14;--input:#111118;--border:#1a1a28;--text:#fff;--dim:#8585a0;--muted:#4a4a60;--accent:#00e5ff;--accent2:#6366f1;--success:#22c55e;--error:#ef4444;--warning:#f59e0b;--grad:linear-gradient(135deg,#00e5ff,#6366f1,#22c55e)}
    body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
    .card{width:100%;max-width:440px;background:var(--card);border:1px solid var(--border);border-radius:24px;overflow:hidden;box-shadow:0 25px 80px rgba(0,0,0,.5)}
    .header{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .title{display:flex;align-items:center;gap:10px;font-size:1.2rem;font-weight:700}
    .badge{padding:4px 10px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);border-radius:6px;font-size:.65rem;font-weight:700;color:var(--warning);text-transform:uppercase}
    .body{padding:1.5rem}
    .group{margin-bottom:1rem}
    .label{display:flex;justify-content:space-between;margin-bottom:8px;font-size:.75rem;font-weight:600;color:var(--dim);text-transform:uppercase}
    .balance{font-family:'JetBrains Mono',monospace;color:var(--text)}
    .select-wrap{position:relative}
    select{width:100%;padding:1rem;padding-right:2.5rem;background:var(--input);border:1px solid var(--border);border-radius:14px;color:var(--text);font-family:inherit;font-size:.95rem;cursor:pointer;appearance:none}
    select:focus{outline:none;border-color:var(--accent)}
    select:disabled{opacity:.5}
    .arrow{position:absolute;right:1rem;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}
    .swap-row{display:flex;justify-content:center;margin:-.25rem 0 .75rem}
    .swap-btn{width:42px;height:42px;background:var(--bg);border:2px solid var(--border);border-radius:12px;color:var(--dim);font-size:1.1rem;cursor:pointer;transition:all .3s}
    .swap-btn:hover{border-color:var(--accent);color:var(--accent);transform:rotate(180deg)}
    .swap-btn:disabled{opacity:.4;transform:none}
    .amount-wrap{position:relative}
    .amount-input{width:100%;padding:1rem;padding-right:115px;background:var(--input);border:1px solid var(--border);border-radius:14px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:600}
    .amount-input:focus{outline:none;border-color:var(--accent)}
    .amount-input:disabled{opacity:.5}
    .amount-input::placeholder{color:var(--muted);font-weight:400}
    .amount-actions{position:absolute;right:.75rem;top:50%;transform:translateY(-50%);display:flex;gap:6px;align-items:center}
    .max-btn{padding:5px 8px;background:rgba(0,229,255,.1);border:none;border-radius:5px;color:var(--accent);font-size:.65rem;font-weight:700;cursor:pointer}
    .max-btn:hover{background:rgba(0,229,255,.2)}
    .token{padding:6px 10px;background:var(--accent2);border-radius:6px;font-size:.8rem;font-weight:700}
    .info{padding:.875rem;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.15);border-radius:10px;margin-bottom:1rem;font-size:.8rem;color:var(--warning)}
    .info a{color:var(--warning)}
    .error{padding:.875rem;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.15);border-radius:10px;margin-bottom:1rem;font-size:.85rem;color:var(--error);text-align:center}
    .progress{padding:1.25rem;background:rgba(0,229,255,.03);border:1px solid rgba(0,229,255,.1);border-radius:14px;margin-bottom:1rem}
    .progress-bar{height:5px;background:var(--input);border-radius:3px;overflow:hidden;margin-bottom:1.25rem}
    .progress-fill{height:100%;background:var(--grad);transition:width .5s}
    .steps{display:flex;justify-content:space-between}
    .step{display:flex;flex-direction:column;align-items:center;gap:6px}
    .step-dot{width:32px;height:32px;background:var(--input);border:2px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700}
    .step.active .step-dot{border-color:var(--accent);background:rgba(0,229,255,.15);color:var(--accent);animation:pulse 1.2s infinite}
    .step.done .step-dot{background:var(--success);border-color:var(--success);color:var(--bg)}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    .step-label{font-size:.65rem;color:var(--muted);text-transform:uppercase}
    .step.active .step-label,.step.done .step-label{color:var(--text)}
    .status-msg{text-align:center;margin-top:1rem;font-size:.8rem;color:var(--dim)}
    .btn{width:100%;padding:1.1rem;background:var(--grad);border:none;border-radius:14px;color:var(--bg);font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .3s}
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,229,255,.3)}
    .btn:disabled{opacity:.45;cursor:not-allowed;transform:none}
    .btn.secondary{background:var(--input);border:2px solid var(--border);color:var(--text)}
    .btn.secondary:hover{border-color:var(--accent);box-shadow:none}
    .spinner{width:18px;height:18px;border:3px solid rgba(0,0,0,.2);border-top-color:var(--bg);border-radius:50%;animation:spin .7s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .success{text-align:center;padding:2rem 1rem}
    .success-icon{width:80px;height:80px;background:var(--success);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 1.25rem;animation:pop .5s}
    @keyframes pop{0%{transform:scale(0)}60%{transform:scale(1.15)}100%{transform:scale(1)}}
    .success h3{font-size:1.3rem;color:var(--success);margin-bottom:.5rem}
    .success p{color:var(--dim);margin-bottom:1.25rem}
    .tx-link{display:block;padding:10px 16px;background:rgba(0,229,255,.08);border:1px solid rgba(0,229,255,.15);border-radius:10px;color:var(--accent);font-family:'JetBrains Mono',monospace;font-size:.8rem;text-decoration:none;margin-bottom:.75rem}
    .tx-link:hover{background:rgba(0,229,255,.15)}
    .connect{text-align:center;padding:2.5rem 1rem}
    .connect-icon{font-size:4rem;margin-bottom:1rem}
    .connect h3{font-size:1.2rem;margin-bottom:.5rem}
    .connect p{color:var(--dim);margin-bottom:1.5rem}
    .footer{padding:.875rem 1.25rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted)}
    .footer a{color:var(--accent);text-decoration:none}
    .server{position:fixed;top:1rem;right:1rem;display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px;font-size:.8rem;color:var(--dim)}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--muted)}
    .dot.online{background:var(--success);box-shadow:0 0 10px var(--success)}
    .dot.offline{background:var(--error)}
    .wallet-btn{position:fixed;top:1rem;left:1rem;padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:.8rem;cursor:pointer}
    .wallet-btn.connected{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.1)}
  </style>
</head>
<body>
  <div class="server"><div class="dot" id="dot"></div><span id="serverText">Verificando...</span></div>
  <button class="wallet-btn" id="walletBtn" onclick="connectWallet()">Conectar</button>
  
  <div class="card">
    <div class="header">
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#2775CA"/><path d="M20.5 18.5c0-2.1-1.3-2.8-3.8-3.1-1.8-.3-2.2-.7-2.2-1.5 0-.8.6-1.3 1.8-1.3 1.1 0 1.7.4 2 1.2h2c-.3-1.7-1.5-2.7-3.2-3v-1.5h-1.8v1.5c-1.8.3-3 1.5-3 3.2 0 2 1.2 2.8 3.7 3.1 1.9.3 2.3.8 2.3 1.6 0 .9-.7 1.5-2 1.5-1.4 0-2-.6-2.3-1.5h-2c.3 1.8 1.5 2.9 3.5 3.2v1.5h1.8V21c1.9-.3 3.2-1.5 3.2-3.5z" fill="#fff"/></svg>
        Bridge USDC
      </div>
      <span class="badge">Testnet</span>
    </div>
    <div class="body" id="body"></div>
    <div class="footer">
      <span>Powered by Circle CCTP</span>
      <a href="https://faucet.circle.com" target="_blank">Faucet ‚Üó</a>
    </div>
  </div>

  <script>
    const API = "https://fluxshift-api.onrender.com";
    const CHAINS = {
      "base-sepolia": {name:"Base Sepolia",icon:"üîµ",chainId:"0x14a34",usdc:"0x036CbD53842c5426634e7929541eC2318f3dCF7e",explorer:"https://sepolia.basescan.org",rpc:"https://sepolia.base.org"},
      "ethereum-sepolia": {name:"Ethereum Sepolia",icon:"‚ü†",chainId:"0xaa36a7",usdc:"0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238",explorer:"https://sepolia.etherscan.io",rpc:"https://rpc.sepolia.org"},
      "arbitrum-sepolia": {name:"Arbitrum Sepolia",icon:"üî∑",chainId:"0x66eee",usdc:"0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d",explorer:"https://sepolia.arbiscan.io",rpc:"https://sepolia-rollup.arbitrum.io/rpc"},
      "optimism-sepolia": {name:"Optimism Sepolia",icon:"üî¥",chainId:"0xaa37dc",usdc:"0x5fd84259d66Cd46123540766Be93DFE6D43130D7",explorer:"https://sepolia-optimism.etherscan.io",rpc:"https://sepolia.optimism.io"}
    };

    let S = {wallet:null,balance:"0.00",from:"base-sepolia",to:"ethereum-sepolia",amount:"",status:"idle",step:0,error:"",links:[],online:false,msg:""};

    async function checkServer(){
      const d=document.getElementById("dot"),t=document.getElementById("serverText");
      try{
        const r=await fetch(API+"/api/status",{signal:AbortSignal.timeout(10000)});
        if(r.ok){S.online=true;d.className="dot online";t.textContent="Online";}
        else throw 0;
      }catch{S.online=false;d.className="dot offline";t.textContent="Offline";}
    }

    async function connectWallet(){
      if(!window.ethereum){alert("Instale MetaMask!");return;}
      try{
        const a=await window.ethereum.request({method:"eth_requestAccounts"});
        S.wallet=a[0];
        updateWalletBtn();
        await getBalance();
        render();
      }catch(e){console.error(e);}
    }

    function updateWalletBtn(){
      const b=document.getElementById("walletBtn");
      if(S.wallet){b.className="wallet-btn connected";b.textContent=S.wallet.slice(0,6)+"..."+S.wallet.slice(-4);}
      else{b.className="wallet-btn";b.textContent="Conectar";}
    }

    async function getBalance(){
      if(!S.wallet)return;
      const c=CHAINS[S.from];
      try{
        const data="0x70a08231000000000000000000000000"+S.wallet.slice(2).toLowerCase();
        // Tentar via RPC direto
        const res=await fetch(c.rpc,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({jsonrpc:"2.0",method:"eth_call",params:[{to:c.usdc,data},"latest"],id:1})
        });
        const json=await res.json();
        if(json.result&&json.result!=="0x"){
          S.balance=(parseInt(json.result,16)/1e6).toFixed(2);
        }else{S.balance="0.00";}
      }catch{S.balance="0.00";}
      render();
    }

    function swap(){[S.from,S.to]=[S.to,S.from];getBalance();}
    function max(){S.amount=S.balance;render();}

    async function bridge(){
      if(!S.online){S.error="Servidor offline. Aguarde 1 min para acordar.";render();return;}
      if(!S.amount||parseFloat(S.amount)<=0){S.error="Digite uma quantidade";render();return;}
      if(parseFloat(S.amount)>parseFloat(S.balance)){S.error="Saldo insuficiente. Obtenha USDC: faucet.circle.com";render();return;}
      if(S.from===S.to){S.error="Selecione redes diferentes";render();return;}

      S.status="processing";S.step=1;S.error="";S.links=[];S.msg="Aprovando USDC...";render();

      try{
        const r=await fetch(API+"/api/bridge",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({fromChain:S.from,toChain:S.to,amount:S.amount}),
          signal:AbortSignal.timeout(300000)
        });
        const d=await r.json();
        console.log("Resposta:",d);
        
        if(d.success){
          S.status="success";S.step=3;
          S.links=(d.steps||[]).filter(s=>s.explorerUrl).map(s=>({name:s.name,url:s.explorerUrl}));
          setTimeout(getBalance,2000);
        }else{
          throw new Error(d.error||"Erro");
        }
      }catch(e){
        S.status="error";
        S.error=e.name==="TimeoutError"?"Timeout. Verifique no explorer.":e.message;
      }
      render();
    }

    function reset(){S.status="idle";S.step=0;S.amount="";S.error="";S.links=[];S.msg="";getBalance();}

    function render(){
      const B=document.getElementById("body");
      const fc=CHAINS[S.from],tc=CHAINS[S.to];

      if(!S.wallet){
        B.innerHTML=`<div class="connect"><div class="connect-icon">üëõ</div><h3>Conecte sua Carteira</h3><p>Conecte MetaMask para transferir USDC entre redes.</p><button class="btn" onclick="connectWallet()">Conectar MetaMask</button></div>`;
        return;
      }

      if(S.status==="success"){
        const links=S.links.length?S.links.map(l=>`<a class="tx-link" href="${l.url}" target="_blank">${l.name} ‚Üí Explorer ‚Üó</a>`).join(""):`<a class="tx-link" href="${tc.explorer}/address/${S.wallet}" target="_blank">Ver carteira ‚Üó</a>`;
        B.innerHTML=`<div class="success"><div class="success-icon">‚úì</div><h3>Conclu√≠do!</h3><p>${S.amount} USDC de ${fc.name} para ${tc.name}</p>${links}<button class="btn secondary" onclick="reset()">Nova Transfer√™ncia</button></div>`;
        return;
      }

      const opts=Object.entries(CHAINS).map(([k,v])=>`<option value="${k}">${v.icon} ${v.name}</option>`).join("");
      const proc=S.status==="processing";
      const can=S.amount&&parseFloat(S.amount)>0&&parseFloat(S.amount)<=parseFloat(S.balance)&&S.online&&S.from!==S.to;

      let info="";
      if(!S.online)info=`<div class="info">‚ö†Ô∏è Servidor offline. Aguarde ~1 min para acordar (plano gratuito hiberna).</div>`;
      else if(parseFloat(S.balance)===0)info=`<div class="info">üí° Sem USDC nesta rede. Obtenha em: <a href="https://faucet.circle.com" target="_blank">faucet.circle.com</a></div>`;

      let prog="";
      if(proc){
        const steps=["Aprovar","Burn","Mint"];
        prog=`<div class="progress"><div class="progress-bar"><div class="progress-fill" style="width:${S.step/3*100}%"></div></div><div class="steps">${steps.map((n,i)=>{const num=i+1;return`<div class="step ${S.step>num?"done":""} ${S.step===num?"active":""}"><div class="step-dot">${S.step>num?"‚úì":num}</div><span class="step-label">${n}</span></div>`;}).join("")}</div><div class="status-msg">${S.msg}</div></div>`;
      }

      B.innerHTML=`
        ${info}
        <div class="group"><label class="label">De (Origem)</label><div class="select-wrap"><select id="fromSel" ${proc?"disabled":""} onchange="S.from=this.value;getBalance()">${opts}</select><span class="arrow">‚ñº</span></div></div>
        <div class="swap-row"><button class="swap-btn" onclick="swap()" ${proc?"disabled":""}>‚áÖ</button></div>
        <div class="group"><label class="label">Para (Destino)</label><div class="select-wrap"><select id="toSel" ${proc?"disabled":""} onchange="S.to=this.value;render()">${opts}</select><span class="arrow">‚ñº</span></div></div>
        <div class="group"><label class="label"><span>Quantidade</span><span class="balance">Saldo: ${S.balance} USDC</span></label><div class="amount-wrap"><input type="number" class="amount-input" placeholder="0.00" value="${S.amount}" oninput="S.amount=this.value" ${proc?"disabled":""}><div class="amount-actions"><button class="max-btn" onclick="max()" ${proc?"disabled":""}>MAX</button><span class="token">USDC</span></div></div></div>
        ${prog}
        ${S.error?`<div class="error">${S.error}</div>`:""}
        <button class="btn" onclick="bridge()" ${proc||!can?"disabled":""}>${proc?`<span class="spinner"></span>Processando...`:"Bridge USDC"}</button>
      `;
      document.getElementById("fromSel").value=S.from;
      document.getElementById("toSel").value=S.to;
    }

    // Init
    checkServer();
    setInterval(checkServer,30000);
    render();
    if(window.ethereum){
      window.ethereum.on("accountsChanged",a=>{S.wallet=a[0]||null;S.balance="0.00";if(S.wallet)getBalance();updateWalletBtn();render();});
      window.ethereum.on("chainChanged",()=>getBalance());
    }
  </script>
</body>
</html>
